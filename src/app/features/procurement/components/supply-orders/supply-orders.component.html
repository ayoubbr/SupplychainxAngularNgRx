<div class="orders-container">
  <div class="page-header">
    <div class="header-content">
      <h1>Commandes d'Approvisionnement</h1>
      <p>Suivi des commandes fournisseurs</p>
    </div>
    <div class="simple-flex">
      <button class="btn btn-secondary" routerLink="/procurement/dashboard">
        <span>üìë</span> Dashboard
      </button>
      <button class="btn btn-primary" (click)="showForm = true">
        <span>+</span> Nouvelle Commande
      </button>
    </div>
  </div>

  <!-- Filters / Search -->
  <div class="filters-bar glass-panel">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input type="text" placeholder="Rechercher une commande..." class="search-input">
    </div>
    <div class="filter-actions">
      <button class="btn btn-secondary btn-icon">‚ö° Filtres</button>
      <button class="btn btn-secondary btn-icon">üì• Exporter</button>
    </div>
  </div>

  <!-- Data Table -->
  <div class="table-container glass-panel">
    <table class="data-table">
      <thead>
        <tr>
          <th>ID Commande</th>
          <th>Date</th>
          <th>Fournisseur</th>
          <th>Number of RM</th>
          <th>Statut</th>
          <th>Date Livraison Pr√©vue</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let order of orders">
          <td><span class="id-badge">#{{ order.id }}</span></td>
          <td>{{ order.date }}</td>
          <td>{{ order.supplier.name }}</td>
          <td>{{ order.rawMaterials.length }}</td>
          <td>
            <span class="status-badge" [ngClass]="order.status.toLowerCase()">
              {{ order.status.replace('_', ' ') }}
            </span>
          </td>
          <td>{{ order.supplier.leadTime }} (Jours Apres Date)</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon-small view" title="Voir">üëÅÔ∏è</button>

              <button *ngIf="order.status !== 'RECUE'" class="btn-icon-small edit" (click)="receive(order.id)">‚úÖ
              </button>

              <button class="btn-icon-small delete" (click)="delete(order.id)">üóëÔ∏è
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Form Overlay -->
<div class="form-overlay" *ngIf="showForm" (click)="closeForm()">
  <div class="form-card glass-panel" (click)="$event.stopPropagation()">
    <div class="form-header">
      <h2>Nouvelle Commande</h2>
      <button class="close-btn" (click)="closeForm()">‚úï</button>
    </div>

    <!-- STEP 1: Supplier Selection -->
    <div *ngIf="formStep === 'supplier-selection'" class="selection-step">
      <h3 style="margin-bottom: 1rem;">Choisir un Fournisseur</h3>

      <div class="suppliers-list">
        <div *ngFor="let supplier of availableSuppliers" class="supplier-card glass-panel"
          (click)="selectSupplier(supplier)">
          <div class="supplier-header">
            <div>
              <h4 class="supplier-name">{{ supplier.name }}</h4>
              <p class="supplier-contact">{{ supplier.contact }}</p>
            </div>
            <div class="supplier-badges">
              <span class="badge-rating">{{ supplier.rating }}‚≠ê</span>
              <span class="badge-lead">{{ supplier.leadTime }}j</span>
            </div>
          </div>

          <div class="supplier-materials">
            <p class="materials-label">Mati√®res premi√®res disponibles ({{ supplier.rawMaterials.length }}):</p>
            <div class="materials-tags">
              <span *ngFor="let rm of supplier.rawMaterials" class="material-tag">
                {{ rm.name }}
              </span>
            </div>
          </div>

          <div class="card-arrow">‚Üí</div>
        </div>
      </div>

      <div class="form-actions" style="margin-top: 1.5rem;">
        <button type="button" class="btn btn-secondary" (click)="closeForm()">Annuler</button>
      </div>
    </div>

    <!-- STEP 2: Material Selection -->
    <div *ngIf="formStep === 'material-selection'" class="selection-step">
      <div class="step-header">
        <button type="button" class="btn btn-secondary btn-small" (click)="backToSupplierSelection()">
          ‚Üê Changer Fournisseur
        </button>
        <div class="supplier-info-compact">
          <strong>{{ selectedSupplier?.name }}</strong>
          <span class="text-muted">{{ selectedSupplier?.rating }}‚≠ê ‚Ä¢ {{ selectedSupplier?.leadTime }}j</span>
        </div>
      </div>

      <h3 style="margin: 1.5rem 0 1rem;">
        S√©lectionner les Mati√®res Premi√®res
      </h3>

      <div class="raw-materials-grid">
        <div *ngFor="let rm of selectedSupplier?.rawMaterials" class="raw-material-card"
          [class.selected]="isRawMaterialSelected(rm.id)" (click)="toggleRawMaterialSelection(rm.id)">
          <div class="card-content">
            <span class="material-name">{{ rm.name }}</span>
            <span class="checkbox">
              {{ isRawMaterialSelected(rm.id) ? '‚úì' : '' }}
            </span>
          </div>
          <p *ngIf="rm.category" class="material-category">{{ rm.category }}</p>
        </div>
      </div>

      <div class="form-actions" style="margin-top: 1.5rem;">
        <button type="button" class="btn btn-secondary" (click)="closeForm()">Annuler</button>
        <button type="button" class="btn btn-primary" (click)="proceedToQuantityEntry()">
          Continuer ({{ selectedRawMaterialIds.size }})
        </button>
      </div>
    </div>

    <!-- STEP 3: Quantity Entry -->
    <form *ngIf="formStep === 'quantity-entry'" class="glass-form" [formGroup]="form" (ngSubmit)="submit()">
      <div class="step-header">
        <button type="button" class="btn btn-secondary btn-small" (click)="backToMaterialSelection()">
          ‚Üê Retour
        </button>
        <div class="supplier-info-compact">
          <strong>{{ selectedSupplier?.name }}</strong>
          <span class="text-muted">{{ selectedRawMaterialIds.size }} mati√®re(s) s√©lectionn√©e(s)</span>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>Date de commande *</label>
          <input type="date" formControlName="orderDate">
        </div>

        <!--        <div class="form-group">-->
        <!--          <label>Statut</label>-->
        <!--          <select formControlName="status">-->
        <!--            <option value="EN_ATTENTE">EN_ATTENTE</option>-->
        <!--            <option value="EN_COURS">EN_COURS</option>-->
        <!--            <option value="RECUE">RECUE</option>-->
        <!--          </select>-->
        <!--        </div>-->
      </div>

      <!-- Raw Materials Quantities -->
      <div class="raw-materials-details" formArrayName="rawMaterials">
        <h3 style="margin: 1.5rem 0 1rem;">
          Quantit√©s des Mati√®res Premi√®res
        </h3>

        <div *ngFor="let item of rawMaterials.controls; let i = index" [formGroupName]="i"
          class="material-detail-card glass-panel">
          <div class="material-row">
            <div class="material-info">
              <span class="material-number">{{ i + 1 }}.</span>
              <strong class="material-name-display">{{ item.get('rawMaterialName')?.value }}</strong>
            </div>

            <div class="form-group compact">
              <label>Quantit√© *</label>
              <input type="number" formControlName="quantity" min="1" placeholder="Qt√©" class="quantity-input">
            </div>
          </div>
        </div>
      </div>

      <div class="form-actions" style="margin-top: 1.5rem;">
        <button type="button" class="btn btn-secondary" (click)="closeForm()">Annuler</button>
        <button type="submit" class="btn btn-primary" [disabled]="form.invalid">
          Cr√©er Commande
        </button>
      </div>
    </form>
  </div>
</div>
